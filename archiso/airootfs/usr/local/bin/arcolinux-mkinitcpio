#!/bin/bash
# driver=free or driver=nonfree - grub and efi
echo "#################################"
echo "Start arcolinux-mkinitcpio"
echo "#################################"
kernel_cmdline(){
	for param in $(cat /proc/cmdline); do
		case "${param}" in
			$1=*) echo "${param##*=}"; return 0 ;;
			$1) return 0 ;;
			*) continue ;;
		esac
	done
	[ -n "${2}" ] && echo "${2}"
	return 1
}

get_driver(){
	echo $(kernel_cmdline driver)
}

result=$(systemd-detect-virt)
echo "#################################"
echo "You are working on "$result
echo "#################################"

selection=$(get_driver)
echo "#################################"
echo "Selection was "$selection
echo "#################################"

##############################################################################################

# free = remove nvidia-dkms keep nouveau
if [[ $selection == "free" ]]; then
	if [ $result = "none" ]; then
		#mkinitcpio.conf for amd and intel only for real metal
		if [ -n "$(lspci -nn | grep "\[03" | grep -i intel)" ]; then
		    echo "Setting modules in /etc/mkinitcpio.conf to i915"
		    FIND='MODULES=()'
			REPLACE='MODULES=(i915)'
			sed -i "s/$FIND/$REPLACE/g" /etc/mkinitcpio.conf
			FIND='MODULES=""'
			REPLACE='MODULES=(i915)'
			sed -i "s/$FIND/$REPLACE/g" /etc/mkinitcpio.conf
		elif [ -n "$(lspci -nn | grep "\[03" | grep -i amd)" ]; then
		    echo "Setting modules in /etc/mkinitcpio.conf to amdgpu"
			FIND='MODULES=()'
			REPLACE='MODULES=(amdgpu)'
			sed -i "s/$FIND/$REPLACE/g" /etc/mkinitcpio.conf
			FIND='MODULES=""'
			REPLACE='MODULES=(amdgpu)'
			sed -i "s/$FIND/$REPLACE/g" /etc/mkinitcpio.conf
		fi
	fi
fi

##############################################################################################

#freenonouveau = remove nvidia-dkms and nouveau
if [[ $selection == "freenonouveau" ]]; then
	if [ $result = "none" ]; then
		#mkinitcpio.conf for amd and intel only for real metal
		if [ -n "$(lspci -nn | grep "\[03" | grep -i intel)" ]; then
			echo "Setting modules in /etc/mkinitcpio.conf to i915"
			FIND='MODULES=()'
			REPLACE='MODULES=(i915)'
			sed -i "s/$FIND/$REPLACE/g" /etc/mkinitcpio.conf
			FIND='MODULES=""'
			REPLACE='MODULES=(i915)'
			sed -i "s/$FIND/$REPLACE/g" /etc/mkinitcpio.conf
		elif [ -n "$(lspci -nn | grep "\[03" | grep -i amd)" ]; then
			echo "Setting modules in /etc/mkinitcpio.conf to amdgpu"
			FIND='MODULES=()'
			REPLACE='MODULES=(amdgpu)'
			sed -i "s/$FIND/$REPLACE/g" /etc/mkinitcpio.conf
			FIND='MODULES=""'
			REPLACE='MODULES=(amdgpu)'
			sed -i "s/$FIND/$REPLACE/g" /etc/mkinitcpio.conf
		fi
	fi
fi

##############################################################################################

#nonfree = keeping nvidia-dkms and nouveau
if [[ $selection == "nonfree" ]]; then
	if [ $result = "none" ]; then
		echo "Setting modules in /etc/mkinitcpio.conf to nvidia nvidia_modeset nvidia_uvm nvidia_drm"
		FIND='MODULES=()'
		REPLACE='MODULES=(nvidia nvidia_modeset nvidia_uvm nvidia_drm)'
		sed -i "s/$FIND/$REPLACE/g" /etc/mkinitcpio.conf
		FIND='MODULES=""'
		REPLACE='MODULES=(nvidia nvidia_modeset nvidia_uvm nvidia_drm)'
		sed -i "s/$FIND/$REPLACE/g" /etc/mkinitcpio.conf
	fi
fi

##############################################################################################

# nonfreenonouveau : keep nvidia-dkms and remove nouveau
if [[ $selection == "nonfreenonouveau" ]]; then
	if [ $result = "none" ]; then
		echo "Setting modules in /etc/mkinitcpio.conf to nvidia nvidia_modeset nvidia_uvm nvidia_drm"
		FIND='MODULES=()'
		REPLACE='MODULES=(nvidia nvidia_modeset nvidia_uvm nvidia_drm)'
		sed -i "s/$FIND/$REPLACE/g" /etc/mkinitcpio.conf
		FIND='MODULES=""'
		REPLACE='MODULES=(nvidia nvidia_modeset nvidia_uvm nvidia_drm)'
		sed -i "s/$FIND/$REPLACE/g" /etc/mkinitcpio.conf
	fi
fi

echo "#################################"
echo "End arcolinux-mkinitcpio"
echo "#################################"

##############################################################################################